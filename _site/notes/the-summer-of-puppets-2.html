<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1" />


	<title>The Summer of Japanese Puppets, Part 2 · marii</title>


<meta name="description" content="">


<link rel="icon" href="http://localhost:8000/assets/favicon.png">
<link rel="stylesheet" href="http://localhost:8000/assets/core.css">
<link rel="canonical" href="http://localhost:8000/notes/the-summer-of-puppets-2">

<script src="https://use.fontawesome.com/884e80fbb8.js"></script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-106423521-1', 'auto');
  ga('send', 'pageview');

</script>


	</head>

	<body>

		<br/><br/>

<aside class="logo">

	

	<a href="http://localhost:8000/">
		<img src="/assets/snake.png" class="gravatar">
	</a>
	<span class="logo-prompt">Home</span>

</aside>


		<main>
			<article>

	<div class="center">
		<h1>The Summer of Japanese Puppets, Part 2</h1>
		<p>
			
			
			
				<span style="color:#325666">#jupyter</span>&nbsp;&nbsp;
			
			
			
				<span style="color:#71909e">#python</span>&nbsp;&nbsp;
			
			
			
				<span style="color:#325666">#json</span>&nbsp;&nbsp;
			
			
			
				<span style="color:#71909e">#yaml</span>&nbsp;&nbsp;
			
			
			
				<span style="color:#325666">#relational-data</span>
			
		</p>
		<time>July 11, 2017</time>
	</div>

	<div class="divider"></div>

	<p><br />
<img src="http://www.columbia.edu/cgi-bin/dlo?obj=ldpd_bun_slide_493_2_0779_0826&amp;size=medium" style="box-shadow: 2px 2px 4pc #23352a;" />
<br /><br /></p>

<p>This post is part 2 of 4 in a series. Feel free to skip around to:<br /><br /><strong><a href="http://localhost:8000/notes/the-summer-of-puppets">part 1: the task</a></strong>,<br /><strong><a href="http://localhost:8000/notes/the-summer-of-puppets-3">part 3: the site</a></strong>, or<br /><strong><a href="http://localhost:8000/notes/the-summer-of-puppets-4">part 4: epilogue</a></strong>.</p>

<hr />

<h1 id="act-2-data-transformation-montage">Act 2: Data transformation montage</h1>

<p>After taking a detour prototyping with <a href="https://google.github.io/lovefield/">Google Lovefield</a> + <a href="https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API">IndexedDB</a> and making a pitstop to play with <a href="http://graphql.org/">GraphQL</a>, I finally settled on a simpler plan: <strong>export each object type as an array of JSON records, and have each record point to its relationships via arrays of IDs.</strong> With this thought, the montage began:</p>

<h2 id="scene-i-plan--tidy">scene i. plan + tidy</h2>

<h4 id="in-mysql-dumptools-any-ol-erd--openrefine--json-schema">In: <span style="font-weight:400">MySQL dump</span><br />Tools: <span style="font-weight:400">any ol’ <a href="https://www.draw.io/">erd</a> / <a href="http://openrefine.org/">OpenRefine</a> / <a href="http://json-schema.org/">json-schema</a></span></h4>

<p>I started by using a simple entity relationship diagramming (ERD) tool and <a href="http://json-schema.org/">JSON Schema</a> to plan out what each object type (e.g. play, kashira, character, etc.) should look like at the end of the processing stage by asking/answerinq questions like: <em>Which keys does each type need? Which keys should be named in a standardized way across object types? What kind of value does a given key expect (maybe an int? a nullable string…? ), and does it expect 1 or many? What does the object need to “know” about itself, and what can it inherit from other types?</em></p>

<p><br /><a href="/images/erd.png"><img src="/images/erd.png" style="box-shadow: 2px 2px 4pc #23352a;" /></a><br /><br /></p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="s2">"$schema"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
  </span><span class="s2">"definitions"</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w">
  </span><span class="s2">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"author"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="s2">"authors"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="s2">"items"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="s2">"id"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"integer"</span><span class="w"> </span><span class="p">},</span><span class="w">
          </span><span class="s2">"label_eng"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">},</span><span class="w">
          </span><span class="s2">"label_ka"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">},</span><span class="w">
          </span><span class="s2">"dates"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">},</span><span class="w">
          </span><span class="s2">"reference"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">},</span><span class="w">
          </span><span class="s2">"sort_ja"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">},</span><span class="w">
          </span><span class="s2">"play_id"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="s2">"items"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
              </span><span class="s2">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="s2">"id"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"integer"</span><span class="w"> </span><span class="p">}</span><span class="w">
              </span><span class="p">},</span><span class="w">
              </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"object"</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"array"</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Once each type was reasonably mapped out, I exported the MySQL database as a set of CSV files and turned to <a href="http://openrefine.org/">OpenRefine</a> (formerly known as GoogleRefine) to clean them up. I used faceting to get a better sense of each set, recast strings as ints and visa versa, scrubbed out line breaks, dropped unused columns, consolidated similar cells, and so on. Then I renamed as many columns as possible to cohere to the somewhat-standardized JSON schema I’d created, and re-exported them as spiffed-up CSVs.</p>

<p><br /><img src="/images/open-refine.png" style="box-shadow: 2px 2px 4pc #23352a;max-width:600px;" /><br /><br /></p>

<h4 id="out-optimized-csvs">Out: <span style="font-weight:400"><a href="https://github.com/mnyrop/bunraku-ipy/tree/master/in">Optimized CSVs</a></span></h4>

<p><br /></p>

<h2 id="scene-ii-process--convert-to-json">scene ii. Process + convert to JSON</h2>

<h4 id="in-csvstools-ipython--pandas">In: <span style="font-weight:400"><a href="https://github.com/mnyrop/bunraku-ipy/tree/master/in">CSVs</a></span><br />Tools: <span style="font-weight:400"><a href="https://ipython.org/">iPython</a> / <a href="http://pandas.pydata.org/">Pandas</a></span></h4>

<p>Next I created an <a href="https://ipython.org/">iPython</a> (aka Jupyter) notebook running Python 2.7 and imported <a href="http://pandas.pydata.org/">Pandas</a>, which is a data analysis library built on <a href="http://www.numpy.org/">Numpy</a>. Pandas works primarily with a datatype called a dataframe, which takes its name from the same type in <a href="https://www.r-project.org/about.html">R</a>.</p>

<p>After reading each CSV file into my Jupyter notebook as a Pandas dataframe, I was able to perform powerful SQL-like tasks on the data, including a chained <code class="highlighter-rouge">.merge()</code> <code class="highlighter-rouge">.groupby()</code> <code class="highlighter-rouge">.apply(list)</code> function that allowed me to merge a join table onto a dataframe, appending an array of ids from the join onto each row.</p>

<p>For example, given a dataframe of authors and a join table of <code class="highlighter-rouge">author_ids</code> and <code class="highlighter-rouge">play_ids</code>, the function (shown below) will merge a list of <code class="highlighter-rouge">play_ids</code> on to each corresponding author record. This is exactly the task I needed to perform on most data objects—adding multiple plays to each author, multiple performances to each play, multiple scenes to each performance, and so on.</p>

<p><br /><a href="/images/ipy.png"><img src="/images/ipy.png" style="box-shadow: 2px 2px 4pc #23352a;max-width:600px;" /></a><br /><br /></p>

<p>Once each dataframe was transformed to mirror the JSON schema I’d planned, I wrote them out to new json files using Pandas’ <code class="highlighter-rouge">.to_json(orient='records')</code> function. [You can see the complete process and notebook <a href="https://github.com/mnyrop/bunraku-ipy/blob/master/bunraku-online.ipynb">here</a>.]</p>

<h4 id="out-json">Out: <span style="font-weight:400"><a href="https://github.com/mnyrop/bunraku-ipy/tree/master/out/json">JSON</a></span></h4>

<p><br /></p>

<h2 id="scene-iii-minify--convert-to-yaml">scene iii. Minify + convert to YAML</h2>

<h4 id="in-jsontools-jq--pyyaml">In: <span style="font-weight:400"><a href="https://github.com/mnyrop/bunraku-ipy/tree/master/out/json">JSON</a></span><br />Tools: <span style="font-weight:400"><a href="https://stedolan.github.io/jq/">JQ</a> / <a href="http://pyyaml.org/">PyYaml</a></span></h4>

<p>With the bulk of the processing done, I used a few post-processing tricks to make my JSON files smaller and more usable. I used the JSON manipulation library <a href="https://stedolan.github.io/jq/">JQ</a> to drop null key:value pairs from my files, since most objects (especially images) had a <em>lot</em> of empty fields. I also used the option <code class="highlighter-rouge">--compact-output</code> to minify the non-null files:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>jq <span class="s1">'del(.[][] | nulls)'</span> <span class="nt">--compact-output</span> authors.json <span class="o">&gt;</span> authors-min.json
</code></pre></div></div>

<p>[<strong>Bonus:</strong> if you have MySQL installed on your machine, you can use the <a href="https://stackoverflow.com/questions/5956993/mysql-string-replace">string REPLACE function</a> to swap out any null arrays (<code class="highlighter-rouge">[null]</code>) or null values that stayed defined as Pandas’ <code class="highlighter-rouge">NaN</code> for a true <code class="highlighter-rouge">null</code> before using JQ, and make sure that it drops <em>every</em> null pair possible.]</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>replace <span class="s2">"[null]"</span> <span class="s2">"null"</span> <span class="nt">--</span> authors.json
replace <span class="s2">"</span><span class="se">\"</span><span class="s2">nan</span><span class="se">\"</span><span class="s2">"</span> <span class="s2">"null"</span> <span class="nt">--</span> authors.json
</code></pre></div></div>

<p>Since I knew the next step for my data was to to build <a href="https://jekyllrb.com">Jekyll</a> pages (which use <a href="http://www.yaml.org/start.html">YAML</a> front-matter for metadata), I then preemptively converted my JSON files to YAML to make the process of building my site faster. Since YAML is, for all intents and purposes, a <em><a href="http://www.yaml.org/spec/1.2/spec.html#id2759572">natural superset of JSON</a></em>, converting from JSON to YAML is trivial. I used a one-line Python shell script with <a href="http://pyyaml.org/">PyYaml</a> to write out my non-null JSON files to Jekyll-ready YAML ones:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>python <span class="nt">-c</span> <span class="s1">'import sys, yaml, json; yaml.safe_dump(json.load(sys.stdin),
sys.stdout, default_flow_style=False)'</span> &lt; authors-min.json <span class="o">&gt;</span> authors-min.yaml
</code></pre></div></div>

<p><br /><img src="/images/bash.png" style="box-shadow: 2px 2px 4pc #23352a;max-width:600px;" /><br /><br /></p>

<h4 id="out-yaml">Out: <span style="font-weight:400"><a href="https://github.com/mnyrop/bunraku-ipy/tree/master/post-processing/yaml">YAML</a></span></h4>

<p><br /></p>
<h3 id="next--part-3-the-site"><span style="font-weight:400">Next &gt;&gt; </span><a href="http://localhost:8000/notes/the-summer-of-puppets-3">part 3: the site</a></h3>
<p><br /><br /></p>


</article>

<div class="page-navigation">
	
    <a class="next" href="http://localhost:8000/notes/the-summer-of-puppets-3" title="NEXT: The Summer of Japanese Puppets, Part 3">&lt;&lt;</a>
		<span> &middot; </span>
  
		<a class="home" href="http://localhost:8000/" title="Back to Homepage">Home</a>
  
		<span> &middot; </span>
    <a class="prev" href="http://localhost:8000/notes/the-summer-of-puppets" title="PREV: The Summer of Japanese Puppets, Part 1">&gt;&gt;</a>
  
</div>

		</main>

		<div class="footer">
  <br><br><br><br>
  <button>
    <a href="https://twitter.com/mariinyrop" target="_none">
      <i class="fa fa-lg fa-twitter" aria-hidden="true"></i>
    </a>
  </button>
  &nbsp;&nbsp;
  <button>
    <a href="https://github.com/mnyrop" target="_none">
      <i class="fa fa-lg fa-code-fork" aria-hidden="true"></i>
    </a>
  </button>
  &nbsp;&nbsp;
  <button id="btn" data-clipboard-text="m.nyrop@columbia.edu">
    <i class="fa fa-lg fa-envelope-o" aria-hidden="true"></i>
  </button>
  &nbsp;&nbsp;
  <button>
    <a href="https://stackoverflow.com/users/8227741/marii" target="_none">
      <i class="fa fa-lg fa-stack-overflow" aria-hidden="true"></i>
    </a>
  </button>
  &nbsp;&nbsp;
  <button>
    <a href="https://jsfiddle.net/user/marii_/fiddles/" target="_none">
      <i class="fa fa-lg fa-jsfiddle" aria-hidden="true"></i>
    </a>
  </button>
  &nbsp;&nbsp;
  <button>
    <a href="https://rubygems.org/profiles/marii" target="_none">
      <i class="fa fa-lg fa-diamond" aria-hidden="true"></i>
    </a>
  </button>
  &nbsp;&nbsp;
  <!-- <button>
    <a href="/shelf">
      <i class="fa fa-lg fa-book" aria-hidden="true"></i>
    </a>
  </button> -->
  <br><br>
  <br><br><br>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.5.10/clipboard.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script src="https://netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>
<style>
  .tooltip{position:absolute;z-index:1030;display:block;font-size:12px;line-height:1.4;opacity:0;filter:alpha(opacity=0);visibility:visible}.tooltip.in{opacity:.9;filter:alpha(opacity=90)}.tooltip.top{padding:5px 0;margin-top:-3px}.tooltip.right{padding:0 5px;margin-left:3px}.tooltip.bottom{padding:5px 0;margin-top:3px}.tooltip.left{padding:0 5px;margin-left:-3px}.tooltip-inner{max-width:200px;padding:3px 8px;color:#fff;text-align:center;text-decoration:none;background-color:#000;border-radius:4px}.tooltip-arrow{position:absolute;width:0;height:0;border-color:transparent;border-style:solid}.tooltip.top .tooltip-arrow{bottom:0;left:50%;margin-left:-5px;border-top-color:#000;border-width:5px 5px 0}.tooltip.top-left .tooltip-arrow{bottom:0;left:5px;border-top-color:#000;border-width:5px 5px 0}.tooltip.top-right .tooltip-arrow{right:5px;bottom:0;border-top-color:#000;border-width:5px 5px 0}.tooltip.right .tooltip-arrow{top:50%;left:0;margin-top:-5px;border-right-color:#000;border-width:5px 5px 5px 0}.tooltip.left .tooltip-arrow{top:50%;right:0;margin-top:-5px;border-left-color:#000;border-width:5px 0 5px 5px}.tooltip.bottom .tooltip-arrow{top:0;left:50%;margin-left:-5px;border-bottom-color:#000;border-width:0 5px 5px}.tooltip.bottom-left .tooltip-arrow{top:0;left:5px;border-bottom-color:#000;border-width:0 5px 5px}.tooltip.bottom-right .tooltip-arrow{top:0;right:5px;border-bottom-color:#000;border-width:0 5px 5px}
</style>
<script>
  $('#btn').tooltip({
    trigger: 'click',
    placement: 'bottom'
  });
  function setTooltip(message) {
    $('#btn').tooltip('hide')
      .attr('data-original-title', message)
      .tooltip('show');
  }
  function hideTooltip() {
    setTimeout(function() {
      $('button').tooltip('hide');
    }, 1000);
  }
  // Clipboard
  var clipboard = new Clipboard('button');
  clipboard.on('success', function(e) {
    setTooltip('Copied to clipboard!');
    hideTooltip();
  });
  clipboard.on('error', function(e) {
    setTooltip('Failed!');
    hideTooltip();
  });
</script>


	</body>

</html>
