<!DOCTYPE html>
<html lang="en" class="overscroll-none">
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0' name='viewport' />

  <title>marii¨ | the summer of japanese puppets, part 2</title>
  <meta name="description" content="This post is part 2 of 4 in a series. Feel free to skip around to:">

  
  <link rel="icon" href="/assets/favicon.ico" />
  

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="/notes/the-summer-of-puppets-2">

  <link rel="stylesheet" href="https://unpkg.com/@highlightjs/cdn-assets@11.4.0/styles/base16/material-palenight.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/@tailwindcss/typography@0.2.x/dist/typography.min.css">
  <script>
    hljs.configure({ignoreUnescapedHTML: true});
    hljs.highlightAll();
  </script>
  
  
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-F7LL67XEP6"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-F7LL67XEP6');
</script>


</head>


  <body>
    <div class="relative w-screen h-40 sm:mb-6 md:mb-8 bg-yellow-800 relative bg-fixed" style="background-image: url('/assets/banner.png')">
      <div class="container mx-auto pt-5 px-5 max-w-full">
        <a class="text-white no-magic" href="/">
          <img class="max-h-10 invert hover:invert-0" src="/assets/snake.png">
        </a>
      </div>
    </div>
    
    <div class="container mx-auto max-w-screen-lg py-10 px-5 mb-10">
      <nav class="mb-10 flex flex-wrap justify-between gap-4">
    <h1 class="flex-none">
        <a href="/" class="no-magic wavy-heading hover:text-yellow-800" style="font-size:1.75rem">Marii Nyrop</a>
    </h1>
    <div class="flex-none pt-4">
        
            <a href="/#software"
                >Software</a>
            &nbsp;
        
            <a href="/#web-and-teaching"
                >Web + Teaching</a>
            &nbsp;
        
            <a href="/#notes"
                >Notes</a>
            &nbsp;
        
            <a href="/about"
                >CV</a>
            
        
    </div>
</nav>
      <article class="prose prose-p:py-2 mb-10">
  <h2 class="prose-title">
    The Summer of Japanese Puppets, Part 2
  </h2>
  <p>12 July 2017</p>
  <img src="https://www1.columbia.edu/sec-cgi-bin/cul/dlo?obj=ldpd_bun_slide_076_1_1393_2197&size=medium" class="pt-2" style="max-height:34rem;">
  <p>This post is part 2 of 4 in a series. Feel free to skip around to:</p>

<p><a href="/notes/the-summer-of-puppets">part 1: the task</a>,
<a href="/notes/the-summer-of-puppets-3">part 3: the site</a>, or
<a href="/notes/the-summer-of-puppets-4">part 4: epilogue</a>.</p>

<p><strong>Act 2: Data transformation montage</strong></p>

<p>After taking a detour prototyping with <a href="https://google.github.io/lovefield/">Google Lovefield</a> + <a href="https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API">IndexedDB</a> and making a pitstop to play with <a href="https://graphql.org/">GraphQL</a>, I finally settled on a simpler plan: <strong>export each object type as an array of JSON records, and have each record point to its relationships via arrays of IDs.</strong> With this thought, the montage began:</p>

<p><strong>scene i. plan + tidy</strong></p>

<p><strong>In:</strong> MySQL dump</p>

<p><strong>Tools:</strong> any ol’ <a href="https://www.draw.io/">erd</a> / <a href="https://openrefine.org/">OpenRefine</a> / <a href="https://json-schema.org/">json-schema</a></p>

<p>I started by using a simple entity relationship diagramming (ERD) tool and <a href="https://json-schema.org/">JSON Schema</a> to plan out what each object type (e.g. play, kashira, character, etc.) should look like at the end of the processing stage by asking/answerinq questions like: <em>Which keys does each type need? Which keys should be named in a standardized way across object types? What kind of value does a given key expect (maybe an int? a nullable string…? ), and does it expect 1 or many? What does the object need to “know” about itself, and what can it inherit from other types?</em></p>

<p><br /><a href="/images/erd.png"><img src="/images/erd.png" /></a><br /><br /></p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"$schema"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
  </span><span class="nl">"definitions"</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w">
  </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"author"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"authors"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"items"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"integer"</span><span class="w"> </span><span class="p">},</span><span class="w">
          </span><span class="nl">"label_eng"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">},</span><span class="w">
          </span><span class="nl">"label_ka"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">},</span><span class="w">
          </span><span class="nl">"dates"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">},</span><span class="w">
          </span><span class="nl">"reference"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">},</span><span class="w">
          </span><span class="nl">"sort_ja"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w"> </span><span class="p">},</span><span class="w">
          </span><span class="nl">"play_id"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"items"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
              </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"integer"</span><span class="w"> </span><span class="p">}</span><span class="w">
              </span><span class="p">},</span><span class="w">
              </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"object"</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"array"</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Once each type was reasonably mapped out, I exported the MySQL database as a set of CSV files and turned to <a href="https://openrefine.org/">OpenRefine</a> to clean them up. I used faceting to get a better sense of each set, recast strings as ints and visa versa, scrubbed out line breaks, dropped unused columns, consolidated similar cells, and so on. Then I renamed as many columns as possible to cohere to the somewhat-standardized JSON schema I’d created, and re-exported them as spiffed-up CSVs.</p>

<p><br /><img src="/images/open-refine.png" /><br /><br /></p>

<p><strong>Out:</strong> <a href="https://github.com/mnyrop/bunraku-ipy/tree/master/in">Optimized CSVs</a></p>

<p><br /></p>

<p><strong>scene ii. Process + convert to JSON</strong></p>

<p><strong>In:</strong> <a href="https://github.com/mnyrop/bunraku-ipy/tree/master/in">CSVs</a></p>

<p><strong>Tools:</strong> <a href="https://ipython.org/">iPython</a> / <a href="https://pandas.pydata.org/">Pandas</a></p>

<p>Next I created an <a href="https://ipython.org/">iPython</a> (aka Jupyter) notebook imported <a href="https://pandas.pydata.org/">Pandas</a>, which is a data analysis library built on <a href="https://www.numpy.org/">Numpy</a>. Pandas works primarily with a datatype called a dataframe, which takes its name from the same type in <a href="https://www.r-project.org/about.html">R</a>.</p>

<p>After reading each CSV file into my Jupyter notebook as a Pandas dataframe, I was able to perform powerful SQL-like tasks on the data, including a chained <code class="language-plaintext highlighter-rouge">.merge()</code> <code class="language-plaintext highlighter-rouge">.groupby()</code> <code class="language-plaintext highlighter-rouge">.apply(list)</code> function that allowed me to merge a join table onto a dataframe, appending an array of ids from the join onto each row.</p>

<p>For example, given a dataframe of authors and a join table of <code class="language-plaintext highlighter-rouge">author_ids</code> and <code class="language-plaintext highlighter-rouge">play_ids</code>, the function (shown below) will merge a list of <code class="language-plaintext highlighter-rouge">play_ids</code> on to each corresponding author record. This is exactly the task I needed to perform on most data objects—adding multiple plays to each author, multiple performances to each play, multiple scenes to each performance, and so on.</p>

<p><br /><a href="/images/ipy.png"><img src="/images/ipy.png" /></a><br /><br /></p>

<p>Once each dataframe was transformed to mirror the JSON schema I’d planned, I wrote them out to new json files using Pandas’ <code class="language-plaintext highlighter-rouge">.to_json(orient='records')</code> function. (You can see the complete process and notebook <a href="https://github.com/mnyrop/bunraku-ipy/blob/master/bunraku-online.ipynb">here</a>.)</p>

<p>An aside: <em>If i were more versed in the powers of Jupyter and Pandas at the time, I could have connected my notebook directly to the MySQL database and performed the cleaning tasks of OpenRefine with Pandas, skipping the CSV steps entirely. For tips on something similar, check out <strong><a href="/notes/automate-yr-docs-mysql-to-markown-via-py">this post</a></strong>.</em></p>

<p><strong>Out:</strong> <a href="https://github.com/mnyrop/bunraku-ipy/tree/master/out/json">JSON</a></p>

<p><br /></p>

<p><strong>scene iii. Minify</strong></p>

<p><strong>In:</strong> <a href="https://github.com/mnyrop/bunraku-ipy/tree/master/out/json">JSON</a></p>

<p><strong>Tools:</strong> <a href="https://stedolan.github.io/jq/">JQ</a></p>

<p>With the bulk of the processing done, I used a few post-processing tricks to make my JSON files smaller and more usable. I used the JSON manipulation library <a href="https://stedolan.github.io/jq/">JQ</a> to drop null key:value pairs from my files, since most objects (especially images) had a <em>lot</em> of empty fields. I also used the option <code class="language-plaintext highlighter-rouge">--compact-output</code> to minify the non-null files:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>jq <span class="s1">'del(.[][] | nulls)'</span> <span class="nt">--compact-output</span> authors.json <span class="o">&gt;</span> authors-min.json
</code></pre></div></div>

<p>Bonus: <em>if you have MySQL installed on your machine, you can use the <a href="https://stackoverflow.com/questions/5956993/mysql-string-replace">string REPLACE function</a> to swap out any null arrays (<code class="language-plaintext highlighter-rouge">[null]</code>) or null values that stayed defined as Pandas’ <code class="language-plaintext highlighter-rouge">NaN</code> for a true <code class="language-plaintext highlighter-rouge">null</code> before using JQ, and make sure that it drops *every* null pair possible. If not, you can also use <code class="language-plaintext highlighter-rouge">grep</code> and <code class="language-plaintext highlighter-rouge">sed</code>, though it’s less straightforward.</em></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>replace <span class="s2">"[null]"</span> <span class="s2">"null"</span> <span class="nt">--</span> authors.json
<span class="nv">$ </span>replace <span class="s2">"</span><span class="se">\"</span><span class="s2">nan</span><span class="se">\"</span><span class="s2">"</span> <span class="s2">"null"</span> <span class="nt">--</span> authors.json
</code></pre></div></div>

<p><strong>Out:</strong> <a href="https://github.com/mnyrop/bunraku-ipy/tree/master/post-processing/json">better JSON</a></p>

</article>


  <div class="post__paginate border-t border-slate-900 pt-2 mt-4">
    
      <span class="post__paginate-left max-w-sm">
        <a href="/notes/the-summer-of-puppets-3">The Summer of Japanese Puppets, Part 3</a>
      </span>
    

    
      <span class="post__paginate-right max-w-sm">
        <a href="/notes/the-summer-of-puppets">The Summer of Japanese Puppets, Part 1</a>
      </span>
    
  </div>



  <ul id="notes" class="rows">
    <li class="row__cols">
      <div class="row__title">
        
          Notes
        
      </div>
      <div class="row__date">
          Date
      </div>
      <div class="row__cat">
        
          Tags
        
      </div>
    </li>
    
      <li class="row__post">
        <div class="row__title ">
          <a href="/notes/deploy-from-github-to-cpanel">
            Action! Automate FTP deploys from GitHub to CPanel
          </a>
        </div>
        <div class="row__date ">
          2021
        </div>
        <div class="row__cat ">actions;ci;cpanel;github;</div>
      </li>
    
      <li class="row__post">
        <div class="row__title ">
          <a href="/notes/ghostscript-for-washed-out-pdfs">
            Using Ghostscript to Covert Washed-Out PDFs for OCR Processing
          </a>
        </div>
        <div class="row__date ">
          2020
        </div>
        <div class="row__cat ">ghostscript;ocr;bash</div>
      </li>
    
      <li class="row__post">
        <div class="row__title ">
          <a href="/notes/nycdh-2018">
            NYCDH Week Workshop: Publishing Sites with GitHub Pages
          </a>
        </div>
        <div class="row__date ">
          2018
        </div>
        <div class="row__cat ">jekyll;workshop;github;dh</div>
      </li>
    
      <li class="row__post">
        <div class="row__title ">
          <a href="/notes/static-iiif-annotations">
            Create and store static IIIF annotations Minicomp style
          </a>
        </div>
        <div class="row__date ">
          2018
        </div>
        <div class="row__cat ">jekyll;iiif;rake</div>
      </li>
    
      <li class="row__post">
        <div class="row__title ">
          <a href="/notes/govt-document-pipeline">
            Create a Gov't Document Pipeline from Scraping to Full Text OCR
          </a>
        </div>
        <div class="row__date ">
          2017
        </div>
        <div class="row__cat ">bs4;tesseract;ocr</div>
      </li>
    
      <li class="row__post">
        <div class="row__title ">
          <a href="/notes/headless-test-dynamic-search">
            Continuous Integration II: Headless Tests w/ RSpec, Capybara, and Poltergeist
          </a>
        </div>
        <div class="row__date ">
          2017
        </div>
        <div class="row__cat ">ci;rspec;capybara;poltergeist</div>
      </li>
    
      <li class="row__post">
        <div class="row__title ">
          <a href="/notes/jekyll-ci">
            Continuous Integration! Or: Jekyll Gets Some Robot Nannies.
          </a>
        </div>
        <div class="row__date ">
          2017
        </div>
        <div class="row__cat ">jekyll;ci</div>
      </li>
    
      <li class="row__post">
        <div class="row__title ">
          <a href="/notes/automate-yr-docs-mysql-to-markown-via-py">
            Automate docs for DB updates with Pandas + Markdown
          </a>
        </div>
        <div class="row__date ">
          2017
        </div>
        <div class="row__cat ">documentation;myql;python;markdown</div>
      </li>
    
      <li class="row__post">
        <div class="row__title ">
          <a href="/notes/the-summer-of-puppets-4">
            The Summer of Japanese Puppets, Part 4
          </a>
        </div>
        <div class="row__date ">
          2017
        </div>
        <div class="row__cat ">d3js;lunr;jekyll</div>
      </li>
    
      <li class="row__post">
        <div class="row__title ">
          <a href="/notes/the-summer-of-puppets-3">
            The Summer of Japanese Puppets, Part 3
          </a>
        </div>
        <div class="row__date ">
          2017
        </div>
        <div class="row__cat ">jekyll;github-pages;liquid</div>
      </li>
    
      <li class="row__post">
        <div class="row__title row__active">
          <a href="/notes/the-summer-of-puppets-2">
            The Summer of Japanese Puppets, Part 2
          </a>
        </div>
        <div class="row__date row__active">
          2017
        </div>
        <div class="row__cat row__active">jupyter;python;json;openrefine</div>
      </li>
    
      <li class="row__post">
        <div class="row__title ">
          <a href="/notes/the-summer-of-puppets">
            The Summer of Japanese Puppets, Part 1
          </a>
        </div>
        <div class="row__date ">
          2017
        </div>
        <div class="row__cat ">sql;jekyll;php</div>
      </li>
    
  </ul>



    </div>
  </body>

</html>