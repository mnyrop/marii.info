<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0' name='viewport' />

  <title>marii¨ | automate docs for db updates with pandas + markdown</title>
  <meta name="description" content="As part of my gig as the DH developer for Columbia University Libraries, I’ve become the data steward of the Foreign Relations of the United States (FRUS) co...">

  
  <link rel="icon" href="/assets/favicon.ico" />
  

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="/notes/automate-yr-docs-mysql-to-markown-via-py">

  <link rel="stylesheet" href="https://unpkg.com/@highlightjs/cdn-assets@11.4.0/styles/base16/material-palenight.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
  <script>
    hljs.configure({ignoreUnescapedHTML: true});
    hljs.highlightAll();
  </script>
  
  
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-F7LL67XEP6"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-F7LL67XEP6');
</script>

</head>


  <body>
    <div style="
      position: absolute;
      top: 0;
      left: 0;
      width: 100vw;
      background: #0e0e0e;
      background-image: url('/assets/banner.png');
      height: 100px;
      background-size: cover;
    "></div>

    <div class="container" style="padding-top:50px">
      <div class="bio">
  <div class="bio__header">
  	<a href="/" class="no-magic"><img src="/assets/snake.png" alt="2 headed snake logo" style="width:100px;"/></a>
  </div>
  <!-- <div class="bio__desc"></div> -->
  <div class="bio__menu">
    
    <a href="/">Home</a>&nbsp;
    
    <a href="/about">CV</a>&nbsp;
    
    <a href="/listening">Listening</a>&nbsp;
    
    <a href="/playing">Playing</a>&nbsp;
    
    <a href="/reading">Reading</a>&nbsp;
    
  </div>
</div>

      <div class="post">
        <h1><a href="/#notes">notes</a> > Automate docs for DB updates with Pandas + Markdown</h2>
        <p class="project__meta">
          26 August 2017
          <!-- <br>
          documentation;myql;python;markdown -->
        </p>

        <div class="post__body">
          <img src="https://nsarchive2.gwu.edu/NSAEBB/NSAEBB601-British-appealed-to-US-in-1952-for-coup-against-Mosaddeq-in-Iran/images/1.jpg" />
          <p>As part of my gig as the DH developer for Columbia University Libraries, I’ve become the data steward of the <a href="https://history.state.gov/historicaldocuments/about-frus">Foreign Relations of the United States</a> (FRUS) collection for the  <a href="https://history-lab.org/">History Lab</a> project.</p>

<p>This means that, as newly declassified and processed FRUS volumes are released by the State Department as <a href="https://github.com/HistoryAtState/frus/tree/master/volumes">XML files</a>, it’s my job to re-process the collection with the newly added volumes, ingest the processed data into to our MySQL database, and make sure the metadata connecting the volumes to History_Lab’s own bleeding edge <a href="https://history-lab.org/documentation/">topic modeling and named-entity recognition (NER)</a> is preserved for further research.</p>

<p>In practice, this means I need to: regenerate the data as a brand new, ‘update’ database, copy over a select number of tables containing the additional data that History_Lab has produced, and test the fidelity of the new database before passing it up the chain of command.</p>

<p>Because of the enormity of the collection (~300K documents and growing!), manual sanity checks and documentation workflows just aren’t cutting it. To address these issues, I spent some time making the ingestion scripts themselves a bit smarter and more verbose, then turned to questions of documentation, including:</p>

<p><strong><em>How do i automate all these <code class="language-plaintext highlighter-rouge">DESCRIBE table;</code>, <code class="language-plaintext highlighter-rouge">SELECT * FROM table LIMIT 5;</code>, and <code class="language-plaintext highlighter-rouge">SELECT COUNT(*) FROM table</code> SQL queries in a reproducible, shareable, easy to read way?</em></strong></p>

<p>Below is the best response I’ve been able to provide for that question. It’s a Python script that <strong>connects to both the production database and the update database created by the ingestion process.</strong> It then extracts information about the databases in the form of Pandas dataframes and <strong>writes a Markdown report of the ingestion results, including:</strong></p>

<ul>
  <li><strong>a list of tables that were dropped</strong> (i.e. tables present in the production db but not in the update db)<br /><br /></li>
  <li><strong>the % change in rowcount</strong> (between the production tables and their update counterparts), and<br /><br /></li>
  <li><strong>at-a-glance previews</strong> (first 5 rows) of each updated table.</li>
</ul>

<p>Because I included this script directly in the ingestion pipeline, the markdown report is automatically generated on ingest and needs only to be pushed to my repository’s <code class="language-plaintext highlighter-rouge">documentation</code> directory after the process is complete.</p>

<h2 id="the-cnf-file">the .cnf file</h2>

<p><em><sup>(You can learn more about .cnf option files <a href="https://dev.mysql.com/doc/refman/5.7/en/option-files.html">here</a>.)</sup></em></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[client]
user= # your mysql username
password= # your mysql password
host= # your mysql host (url or localhost)
</code></pre></div></div>

<h2 id="the-main-script">the main script</h2>
<p><em><sup>(aka <code class="language-plaintext highlighter-rouge">results.py</code> or something similar)</sup></em></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># get necessary modules
</span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">pymysql</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="nn">ConfigParser</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">codecs</span>
<span class="kn">from</span> <span class="nn">pandas.api.types</span> <span class="kn">import</span> <span class="n">is_string_dtype</span>

<span class="c1"># relative path to your mysql login .cnf file
</span><span class="n">conf_path</span> <span class="o">=</span> <span class="s">"common/mylogin.cnf"</span> <span class="c1"># path to your root dir for finding
</span>
<span class="c1"># output vars
</span><span class="n">report_title</span> <span class="o">=</span> <span class="s">"FRUS Collection Ingest Update"</span>
<span class="n">file_prefix</span> <span class="o">=</span> <span class="s">"FRUS-ingest-results"</span>

<span class="c1"># pick which dbs to compare
</span><span class="n">update_name</span> <span class="o">=</span> <span class="s">"frus_update"</span>
<span class="n">prod_name</span> <span class="o">=</span> <span class="s">"frus"</span>

<span class="c1"># parse config for connecting to dbs
</span><span class="n">config</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="p">.</span><span class="n">RawConfigParser</span><span class="p">()</span>
<span class="n">config</span><span class="p">.</span><span class="n">readfp</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">conf_path</span><span class="p">)))</span>
<span class="n">db_user</span> <span class="o">=</span> <span class="n">config</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'client'</span><span class="p">,</span> <span class="s">'user'</span><span class="p">)</span>
<span class="n">db_pass</span> <span class="o">=</span> <span class="n">config</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'client'</span><span class="p">,</span> <span class="s">'password'</span><span class="p">)</span>
<span class="n">db_host</span> <span class="o">=</span> <span class="n">config</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'client'</span><span class="p">,</span> <span class="s">'host'</span><span class="p">)</span>

<span class="c1"># connect to dbs
</span><span class="n">prod_db</span> <span class="o">=</span> <span class="n">connect_db</span><span class="p">(</span><span class="n">prod_name</span><span class="p">)</span>
<span class="n">update_db</span> <span class="o">=</span> <span class="n">connect_db</span><span class="p">(</span><span class="n">update_name</span><span class="p">)</span>

<span class="c1"># get list of tables in each db
</span><span class="n">prod_tables</span> <span class="o">=</span> <span class="n">show_tables</span><span class="p">(</span><span class="n">prod_db</span><span class="p">)</span>
<span class="n">update_tables</span> <span class="o">=</span> <span class="n">show_tables</span><span class="p">(</span><span class="n">update_db</span><span class="p">)</span>

<span class="c1"># get lists of common and missing tables
</span><span class="n">common_tables</span> <span class="o">=</span> <span class="n">common_tables</span><span class="p">(</span><span class="n">prod_tables</span><span class="p">,</span> <span class="n">update_tables</span><span class="p">)</span>
<span class="n">missing_tables</span> <span class="o">=</span> <span class="n">missing_tables</span><span class="p">(</span><span class="n">prod_tables</span><span class="p">,</span> <span class="n">common_tables</span><span class="p">)</span>

<span class="c1"># construct the info to report
</span><span class="n">h1</span> <span class="o">=</span> <span class="s">"# "</span> <span class="o">+</span> <span class="n">report_title</span> <span class="o">+</span> <span class="s">" — "</span> <span class="o">+</span> <span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">.</span><span class="n">now</span><span class="p">().</span><span class="n">strftime</span><span class="p">(</span><span class="s">"%m-%d-%Y"</span><span class="p">)</span> <span class="o">+</span> <span class="s">"</span><span class="se">\n\n\n</span><span class="s">"</span>
<span class="n">missing_table_list</span> <span class="o">=</span> <span class="n">format_list</span><span class="p">(</span><span class="s">"tables dropped on update"</span><span class="p">,</span> <span class="n">missing_tables</span><span class="p">)</span>
<span class="n">rowcount_changes</span> <span class="o">=</span> <span class="s">"### `"</span> <span class="o">+</span> <span class="n">prod_name</span> <span class="o">+</span> <span class="s">"` vs `"</span> <span class="o">+</span> <span class="n">update_name</span> <span class="o">+</span> <span class="s">"`</span><span class="se">\n\n</span><span class="s">"</span> <span class="o">+</span> <span class="n">markdown_table</span><span class="p">(</span><span class="n">rowcount_changes</span><span class="p">(</span><span class="n">common_tables</span><span class="p">,</span> <span class="n">prod_db</span><span class="p">,</span> <span class="n">update_db</span><span class="p">))</span> <span class="o">+</span> <span class="s">"</span><span class="se">\n\n\n</span><span class="s">"</span>
<span class="n">formatted_previews</span> <span class="o">=</span> <span class="n">formatted_previews</span><span class="p">(</span><span class="n">update_name</span><span class="p">,</span> <span class="n">update_db</span><span class="p">,</span> <span class="n">common_tables</span><span class="p">)</span>

<span class="c1"># concatenate report info as a single string
</span><span class="n">file_as_string</span> <span class="o">=</span> <span class="n">h1</span> <span class="o">+</span> <span class="n">missing_table_list</span> <span class="o">+</span> <span class="n">rowcount_changes</span> <span class="o">+</span> <span class="n">update_previews</span>

<span class="c1"># write string to filepath
</span><span class="n">filepath</span> <span class="o">=</span> <span class="n">file_prefix</span> <span class="o">+</span><span class="s">"-"</span> <span class="o">+</span> <span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">.</span><span class="n">now</span><span class="p">().</span><span class="n">strftime</span><span class="p">(</span><span class="s">"%m-%d-%Y"</span><span class="p">)</span> <span class="o">+</span> <span class="s">".md"</span>
<span class="k">print</span> <span class="s">"Writing results of ingestion to "</span> <span class="o">+</span> <span class="n">filepath</span> <span class="o">+</span> <span class="s">"..."</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">os</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
<span class="k">except</span> <span class="nb">OSError</span><span class="p">:</span>
    <span class="k">pass</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">codecs</span><span class="p">.</span><span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">'utf-8'</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">"w+"</span><span class="p">)</span>
<span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="nb">unicode</span><span class="p">(</span><span class="n">file_as_string</span><span class="p">,</span><span class="s">'utf-8'</span><span class="p">))</span>

</code></pre></div></div>

<h2 id="multi-purpose-methods">multi-purpose methods</h2>

<p><em><sup>(Add the following methods before the config section of the main script, or put them in another file like <code class="language-plaintext highlighter-rouge">helpers.py</code> to be imported as a local module.)</sup></em></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">def</span> <span class="nf">connect_db</span><span class="p">(</span><span class="n">db_name</span><span class="p">):</span> <span class="c1"># takes a database name, returns a db connector
</span>  <span class="k">return</span> <span class="n">pymysql</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">db_host</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">db_user</span><span class="p">,</span> <span class="n">passwd</span><span class="o">=</span><span class="n">db_pass</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="n">db_name</span><span class="p">,</span> <span class="n">charset</span><span class="o">=</span><span class="s">'utf8'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">show_tables</span><span class="p">(</span><span class="n">db</span><span class="p">):</span> <span class="c1"># takes a db connector, returns an array table names
</span>  <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">read_sql</span><span class="p">(</span><span class="s">"SHOW TABLES;"</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">db</span><span class="p">)</span>
  <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">df</span><span class="p">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">])].</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">df</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span> <span class="c1"># takes a db connector and a table name, and returns a pandas dataframe from that table
</span>  <span class="k">return</span> <span class="n">pd</span><span class="p">.</span><span class="n">read_sql</span><span class="p">(</span><span class="s">"SELECT * FROM "</span> <span class="o">+</span> <span class="n">table</span> <span class="o">+</span> <span class="s">";"</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">db</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">df_sample</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">limit</span><span class="p">):</span> <span class="c1"># same as df(), but only returns a sample of LIMIT # of rows
</span>  <span class="k">return</span> <span class="n">pd</span><span class="p">.</span><span class="n">read_sql</span><span class="p">(</span><span class="s">"SELECT * FROM "</span> <span class="o">+</span> <span class="n">table</span> <span class="o">+</span> <span class="s">" LIMIT "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span> <span class="o">+</span> <span class="s">";"</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">db</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">df_rowcount</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span> <span class="c1"># takes a db connector and a table name, and returns a the rowcount (int) of that table
</span>  <span class="k">return</span> <span class="n">pd</span><span class="p">.</span><span class="n">read_sql</span><span class="p">(</span><span class="s">'SELECT COUNT(*) FROM '</span> <span class="o">+</span> <span class="n">table</span> <span class="o">+</span> <span class="s">';'</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">db</span><span class="p">)[</span><span class="s">'COUNT(*)'</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">markdown_table</span><span class="p">(</span><span class="n">df</span><span class="p">):</span> <span class="c1"># takes a pandas dataframe and tur it into returns it as a (string) markdown table
</span>  <span class="n">df_fmt</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">fmt</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="n">df</span><span class="p">.</span><span class="n">columns</span><span class="p">)</span>
  <span class="n">df_formatted</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_fmt</span><span class="p">,</span> <span class="n">df</span><span class="p">])</span>
  <span class="k">return</span> <span class="n">df_formatted</span><span class="p">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">sep</span><span class="o">=</span><span class="s">"|"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">'utf-8'</span><span class="p">,</span> <span class="n">quotechar</span><span class="o">=</span><span class="s">"*"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">rowcount_changes</span><span class="p">(</span><span class="n">shared_tables</span><span class="p">,</span> <span class="n">db1</span><span class="p">,</span> <span class="n">db2</span><span class="p">):</span> <span class="c1"># takes a list of common tables and both db connectors, returns a (string) markdown table representing the changes
</span>  <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s">'table'</span><span class="p">,</span><span class="s">'production db rowcount'</span><span class="p">,</span><span class="s">'update db rowcount'</span><span class="p">,</span><span class="s">'% difference'</span><span class="p">]</span>
  <span class="n">differential_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">)</span>

  <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">shared_tables</span><span class="p">:</span>
    <span class="n">db1_rowcount</span> <span class="o">=</span> <span class="n">df_rowcount</span><span class="p">(</span><span class="n">db1</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>
    <span class="n">db2_rowcount</span> <span class="o">=</span> <span class="n">df_rowcount</span><span class="p">(</span><span class="n">db2</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>

    <span class="n">difference</span> <span class="o">=</span> <span class="n">db2_rowcount</span> <span class="o">-</span> <span class="n">db1_rowcount</span>
    <span class="k">if</span> <span class="n">difference</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">difference</span> <span class="o">=</span> <span class="p">(</span><span class="n">difference</span> <span class="o">/</span> <span class="n">db1_rowcount</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>

    <span class="n">temp_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">([[</span><span class="s">"`"</span> <span class="o">+</span> <span class="n">table</span> <span class="o">+</span> <span class="s">"`"</span><span class="p">,</span> <span class="n">prod_count</span><span class="p">,</span> <span class="n">update_count</span><span class="p">,</span> <span class="n">difference</span><span class="p">]],</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">)</span>

    <span class="n">differential_df</span> <span class="o">=</span> <span class="n">differential_df</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp_df</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">differential_df</span><span class="p">[</span><span class="s">'production db rowcount'</span><span class="p">]</span> <span class="o">=</span> <span class="n">differential_df</span><span class="p">[</span><span class="s">'production db rowcount'</span><span class="p">].</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">differential_df</span><span class="p">[</span><span class="s">'update db rowcount'</span><span class="p">]</span> <span class="o">=</span> <span class="n">differential_df</span><span class="p">[</span><span class="s">'update db rowcount'</span><span class="p">].</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">differential_df</span><span class="p">[</span><span class="s">'% difference'</span><span class="p">]</span> <span class="o">=</span> <span class="n">differential_df</span><span class="p">[</span><span class="s">'% difference'</span><span class="p">]</span>

  <span class="k">return</span> <span class="n">differential_df</span>

<span class="k">def</span> <span class="nf">formatted_previews</span><span class="p">(</span><span class="n">db_name</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">tables</span><span class="p">):</span> <span class="c1"># takes a db name, db connector, and list of tables, returns a string representation of previews for each table in that db
</span>    <span class="n">all_tables_string</span> <span class="o">=</span> <span class="s">"### `"</span> <span class="o">+</span> <span class="n">db_name</span> <span class="o">+</span> <span class="s">" ` preview </span><span class="se">\n\n</span><span class="s">"</span>
    <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
        <span class="n">df_head</span> <span class="o">=</span> <span class="n">df_sample</span><span class="p">(</span><span class="n">db</span><span class="p">,</span><span class="n">table</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df_head</span><span class="p">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">is_string_dtype</span><span class="p">(</span><span class="n">df_head</span><span class="p">[</span><span class="n">col</span><span class="p">]):</span>
                <span class="n">df_head</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_head</span><span class="p">[</span><span class="n">col</span><span class="p">].</span><span class="nb">str</span><span class="p">[:</span><span class="mi">200</span><span class="p">].</span><span class="n">replace</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">,</span><span class="s">' '</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">all_tables_string</span> <span class="o">+=</span> <span class="s">"#### `"</span> <span class="o">+</span> <span class="n">table</span> <span class="o">+</span> <span class="s">"`</span><span class="se">\n\n</span><span class="s">"</span> <span class="o">+</span> <span class="n">markdown_table</span><span class="p">(</span><span class="n">df_head</span><span class="p">)</span> <span class="o">+</span> <span class="s">"</span><span class="se">\n\n</span><span class="s">"</span>
    <span class="k">return</span> <span class="n">all_tables_string</span>

<span class="k">def</span> <span class="nf">common_tables</span><span class="p">(</span><span class="n">table_list1</span><span class="p">,</span> <span class="n">table_list2</span><span class="p">):</span> <span class="c1"># takes lists of tables, returns list of tables present in both lists
</span>  <span class="n">common</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">table_list1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">table_list2</span><span class="p">))</span>
  <span class="n">common</span><span class="p">.</span><span class="n">sort</span><span class="p">()</span>
  <span class="k">return</span> <span class="n">common</span>

<span class="k">def</span> <span class="nf">missing_tables</span><span class="p">(</span><span class="n">table_list1</span><span class="p">,</span> <span class="n">common_table_list</span><span class="p">):</span> <span class="c1"># returns array of table names in table list that aren't in the common list
</span>  <span class="n">missing</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">prod_tables</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">common_tables</span><span class="p">]</span>
  <span class="n">missing</span><span class="p">.</span><span class="n">sort</span><span class="p">()</span>
  <span class="k">return</span> <span class="n">missing</span>

<span class="k">def</span> <span class="nf">format_list</span><span class="p">(</span><span class="n">heading</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span> <span class="c1"># returns md formatted list w h3 heading
</span>  <span class="n">list_string</span> <span class="o">=</span> <span class="s">"###"</span> <span class="o">+</span> <span class="n">heading</span><span class="p">:</span> <span class="o">+</span> <span class="s">" </span><span class="se">\n</span><span class="s">"</span>
  <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">:</span>
      <span class="n">list_string</span> <span class="o">+=</span> <span class="s">"- "</span> <span class="o">+</span> <span class="n">item</span> <span class="o">+</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span>
  <span class="k">return</span> <span class="n">list_string</span> <span class="o">+</span> <span class="s">"</span><span class="se">\n\n\n</span><span class="s">"</span>

</code></pre></div></div>

<h2 id="final-thoughts">Final thoughts:</h2>

<p>I’m hoping to implement this style of automated documentation across History_Lab’s various collection ingestion pipelines. The goal is not only to create standardized, thorough system for documentation, but also to better understand changes to the collection over time and anticipate possible issues.</p>

<p>After several ingestion reports on are generated per collection, I’m hoping to apply insights from them in making the ingestion scripts themselves much smarter—for example by flagging when table row counts change in unexpected ways.</p>

        </div>

        
          <div class="post__paginate">
            
              <span class="post__paginate-left">
                <a href="/notes/the-summer-of-puppets-4">The Summer of Japanese Puppets, Part 4</a>
              </span>
            

            
              <span class="post__paginate-right">
                <a href="/notes/jekyll-ci">Continuous Integration! Or: Jekyll gets some robot nannies.</a>
              </span>
            
          </div>
        
      </div>

      
  <ul class="rows">
    <li class="row__cols">
      <div class="row__title">
        
          Notes
        
      </div>
      <div class="row__date">
          Date
      </div>
      <div class="row__cat">
        
          Tags
        
      </div>
    </li>
    
      <li class="row__post">
        <div class="row__title ">
          <a href="/notes/deploy-from-github-to-cpanel">
            Action! Automate FTP deploys from GitHub to CPanel
          </a>
        </div>
        <div class="row__date ">
          2021
        </div>
        <div class="row__cat ">actions;ci;cpanel;github;</div>
      </li>
    
      <li class="row__post">
        <div class="row__title ">
          <a href="/notes/ghostscript-for-washed-out-pdfs">
            Using Ghostscript to Covert Washed-Out PDFs for OCR Processing
          </a>
        </div>
        <div class="row__date ">
          2020
        </div>
        <div class="row__cat ">ghostscript;ocr;bash</div>
      </li>
    
      <li class="row__post">
        <div class="row__title ">
          <a href="/notes/nycdh-2018">
            NYCDH Week Workshop: Publishing Sites with GitHub Pages
          </a>
        </div>
        <div class="row__date ">
          2018
        </div>
        <div class="row__cat ">jekyll;workshop;github;dh</div>
      </li>
    
      <li class="row__post">
        <div class="row__title ">
          <a href="/notes/static-iiif-annotations">
            Create and store static IIIF annotations Minicomp style
          </a>
        </div>
        <div class="row__date ">
          2018
        </div>
        <div class="row__cat ">jekyll;iiif;rake</div>
      </li>
    
      <li class="row__post">
        <div class="row__title ">
          <a href="/notes/govt-document-pipeline">
            Create a Gov't Document Pipeline from Scraping to Full Text OCR
          </a>
        </div>
        <div class="row__date ">
          2017
        </div>
        <div class="row__cat ">bs4;tesseract;ocr</div>
      </li>
    
      <li class="row__post">
        <div class="row__title ">
          <a href="/notes/headless-test-dynamic-search">
            Continuous Integration II: Headless Tests w/ RSpec, Capybara, and Poltergeist
          </a>
        </div>
        <div class="row__date ">
          2017
        </div>
        <div class="row__cat ">ci;rspec;capybara;poltergeist</div>
      </li>
    
      <li class="row__post">
        <div class="row__title ">
          <a href="/notes/jekyll-ci">
            Continuous Integration! Or: Jekyll gets some robot nannies.
          </a>
        </div>
        <div class="row__date ">
          2017
        </div>
        <div class="row__cat ">jekyll;ci</div>
      </li>
    
      <li class="row__post">
        <div class="row__title row__active">
          <a href="/notes/automate-yr-docs-mysql-to-markown-via-py">
            Automate docs for DB updates with Pandas + Markdown
          </a>
        </div>
        <div class="row__date row__active">
          2017
        </div>
        <div class="row__cat row__active">documentation;myql;python;markdown</div>
      </li>
    
      <li class="row__post">
        <div class="row__title ">
          <a href="/notes/the-summer-of-puppets-4">
            The Summer of Japanese Puppets, Part 4
          </a>
        </div>
        <div class="row__date ">
          2017
        </div>
        <div class="row__cat ">d3js;lunr;jekyll</div>
      </li>
    
      <li class="row__post">
        <div class="row__title ">
          <a href="/notes/the-summer-of-puppets-3">
            The Summer of Japanese Puppets, Part 3
          </a>
        </div>
        <div class="row__date ">
          2017
        </div>
        <div class="row__cat ">jekyll;github-pages;liquid</div>
      </li>
    
      <li class="row__post">
        <div class="row__title ">
          <a href="/notes/the-summer-of-puppets-2">
            The Summer of Japanese Puppets, Part 2
          </a>
        </div>
        <div class="row__date ">
          2017
        </div>
        <div class="row__cat ">jupyter;python;json;openrefine</div>
      </li>
    
      <li class="row__post">
        <div class="row__title ">
          <a href="/notes/the-summer-of-puppets">
            The Summer of Japanese Puppets, Part 1
          </a>
        </div>
        <div class="row__date ">
          2017
        </div>
        <div class="row__cat ">sql;jekyll;php</div>
      </li>
    
  </ul>


    </div>
  </body>

</html>
