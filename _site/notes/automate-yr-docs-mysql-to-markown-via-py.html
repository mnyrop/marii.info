<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1" />


	<title>Peak Laziness:<br>Automate documentation for database updates with Python, Pandas and Markdown · marii</title>


<meta name="description" content="              above: 'British appealed to US in 1952 for coup against Mosaddeq in Iran', from      nsarchive.gwu.edu      ">


<link rel="icon" href="http://localhost:8000/assets/favicon.png">
<link rel="stylesheet" href="http://localhost:8000/assets/core.css">
<link rel="canonical" href="http://localhost:8000/notes/automate-yr-docs-mysql-to-markown-via-py">

<script src="https://use.fontawesome.com/884e80fbb8.js"></script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-106423521-1', 'auto');
  ga('send', 'pageview');

</script>


	</head>

	<body>

		<br/><br/>

<aside class="logo">

	

	<a href="http://localhost:8000/">
		<img src="/assets/snake.png" class="gravatar">
	</a>
	<span class="logo-prompt">Home</span>

</aside>


		<main>
			<article>

	<div class="center">
		<h1>Peak Laziness:<br>Automate documentation for database updates with Python, Pandas and Markdown</h1>
		<p>
			
			
			
				<span style="color:#325666">#markdown</span>&nbsp;&nbsp;
			
			
			
				<span style="color:#71909e">#data-science</span>&nbsp;&nbsp;
			
			
			
				<span style="color:#325666">#python</span>&nbsp;&nbsp;
			
			
			
				<span style="color:#71909e">#pandas</span>
			
		</p>
		<time>September 14, 2017</time>
	</div>

	<div class="divider"></div>

	<center>
  <img src="http://nsarchive2.gwu.edu/NSAEBB/NSAEBB601-British-appealed-to-US-in-1952-for-coup-against-Mosaddeq-in-Iran/images/1.jpg" />
  <p>
    <sup>
      <b>above:</b> 'British appealed to US in 1952 for coup against Mosaddeq in Iran', from
      <a href="http://nsarchive2.gwu.edu/NSAEBB/NSAEBB601-British-appealed-to-US-in-1952-for-coup-against-Mosaddeq-in-Iran/">nsarchive.gwu.edu</a>
    </sup>
  </p>
</center>
<p><br /><br /></p>

<p>As part of my gig as the DH developer for Columbia University Libraries, I’ve become the data steward of the <a href="https://history.state.gov/historicaldocuments/about-frus">Foreign Relations of the United States</a> (FRUS) collection for the  <a href="http://history-lab.org/">History Lab</a> project.</p>

<p>This means that, as newly declassified and processed FRUS volumes are released by the State Department as <a href="https://github.com/HistoryAtState/frus/tree/master/volumes">XML files</a>, it’s my job to re-process the collection with the newly added volumes, ingest the processed data into to our MySQL database, and make sure the metadata connecting the volumes to History_Lab’s own bleeding edge <a href="http://www.history-lab.org/documentation/">topic modeling and named-entity recognition (NER)</a> is preserved for further research.</p>

<p>In practice, this means I need to: regenerate the data as a brand new, ‘update’ database, copy over a select number of tables containing the additional data that History_Lab has produced, and test the fidelity of the new database before passing it up the chain of command.</p>

<p>Because of the enormity of the collection (~300K documents and growing!), manual sanity checks and documentation workflows just aren’t cutting it. To address these issues, I spent some time making the ingestion scripts themselves a bit smarter and more verbose, then turned to questions of documentation, including:</p>

<p><strong><em>How do i automate all these <code class="highlighter-rouge">DESCRIBE table;</code>, <code class="highlighter-rouge">SELECT * FROM table LIMIT 5;</code>, and <code class="highlighter-rouge">SELECT COUNT(*) FROM table</code> SQL queries in a reproducible, shareable, easy to read way?</em></strong></p>

<p>Below is the best response I’ve been able to provide for that question. It’s a Python script that <strong>connects to both the production database and the update database created by the ingestion process.</strong> It then extracts information about the databases in the form of Pandas dataframes and <strong>writes a Markdown report of the ingestion results, including:</strong></p>

<ul>
  <li><strong>a list of tables that were dropped</strong> (i.e. tables present in the production db but not in the update db)<br /><br /></li>
  <li><strong>the % change in rowcount</strong> (between the production tables and their update counterparts), and<br /><br /></li>
  <li><strong>at-a-glance previews</strong> (first 5 rows) of each updated table.</li>
</ul>

<p>Because I included this script directly in the ingestion pipeline, the markdown report is automatically generated on ingest and needs only to be pushed to my repository’s <code class="highlighter-rouge">documentation</code> directory after the process is complete.</p>

<h2 id="the-cnf-file">the .cnf file</h2>

<p><em><sup>(You can learn more about .cnf option files <a href="https://dev.mysql.com/doc/refman/5.7/en/option-files.html">here</a>.)</sup></em></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[client]
user= # your mysql username
password= # your mysql password
host= # your mysql host (url or localhost)
</code></pre></div></div>

<h2 id="the-main-script">the main script</h2>
<p><em><sup>(aka <code class="highlighter-rouge">results.py</code> or something similar)</sup></em></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># get necessary modules</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">pymysql</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="nn">ConfigParser</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">codecs</span>
<span class="kn">from</span> <span class="nn">pandas.api.types</span> <span class="kn">import</span> <span class="n">is_string_dtype</span>

<span class="c"># relative path to your mysql login .cnf file</span>
<span class="n">conf_path</span> <span class="o">=</span> <span class="s">"common/mylogin.cnf"</span> <span class="c"># path to your root dir for finding</span>

<span class="c"># output vars</span>
<span class="n">report_title</span> <span class="o">=</span> <span class="s">"FRUS Collection Ingest Update"</span>
<span class="n">file_prefix</span> <span class="o">=</span> <span class="s">"FRUS-ingest-results"</span>

<span class="c"># pick which dbs to compare</span>
<span class="n">update_name</span> <span class="o">=</span> <span class="s">"frus_update"</span>
<span class="n">prod_name</span> <span class="o">=</span> <span class="s">"frus"</span>

<span class="c"># parse config for connecting to dbs</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="o">.</span><span class="n">RawConfigParser</span><span class="p">()</span>
<span class="n">config</span><span class="o">.</span><span class="n">readfp</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">conf_path</span><span class="p">)))</span>
<span class="n">db_user</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'client'</span><span class="p">,</span> <span class="s">'user'</span><span class="p">)</span>
<span class="n">db_pass</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'client'</span><span class="p">,</span> <span class="s">'password'</span><span class="p">)</span>
<span class="n">db_host</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'client'</span><span class="p">,</span> <span class="s">'host'</span><span class="p">)</span>

<span class="c"># connect to dbs</span>
<span class="n">prod_db</span> <span class="o">=</span> <span class="n">connect_db</span><span class="p">(</span><span class="n">prod_name</span><span class="p">)</span>
<span class="n">update_db</span> <span class="o">=</span> <span class="n">connect_db</span><span class="p">(</span><span class="n">update_name</span><span class="p">)</span>

<span class="c"># get list of tables in each db</span>
<span class="n">prod_tables</span> <span class="o">=</span> <span class="n">show_tables</span><span class="p">(</span><span class="n">prod_db</span><span class="p">)</span>
<span class="n">update_tables</span> <span class="o">=</span> <span class="n">show_tables</span><span class="p">(</span><span class="n">update_db</span><span class="p">)</span>

<span class="c"># get lists of common and missing tables</span>
<span class="n">common_tables</span> <span class="o">=</span> <span class="n">common_tables</span><span class="p">(</span><span class="n">prod_tables</span><span class="p">,</span> <span class="n">update_tables</span><span class="p">)</span>
<span class="n">missing_tables</span> <span class="o">=</span> <span class="n">missing_tables</span><span class="p">(</span><span class="n">prod_tables</span><span class="p">,</span> <span class="n">common_tables</span><span class="p">)</span>

<span class="c"># construct the info to report</span>
<span class="n">h1</span> <span class="o">=</span> <span class="s">"# "</span> <span class="o">+</span> <span class="n">report_title</span> <span class="o">+</span> <span class="s">" — "</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">"</span><span class="si">%</span><span class="s">m-</span><span class="si">%</span><span class="s">d-</span><span class="si">%</span><span class="s">Y"</span><span class="p">)</span> <span class="o">+</span> <span class="s">"</span><span class="se">\n\n\n</span><span class="s">"</span>
<span class="n">missing_table_list</span> <span class="o">=</span> <span class="n">format_list</span><span class="p">(</span><span class="s">"tables dropped on update"</span><span class="p">,</span> <span class="n">missing_tables</span><span class="p">)</span>
<span class="n">rowcount_changes</span> <span class="o">=</span> <span class="s">"### `"</span> <span class="o">+</span> <span class="n">prod_name</span> <span class="o">+</span> <span class="s">"` vs `"</span> <span class="o">+</span> <span class="n">update_name</span> <span class="o">+</span> <span class="s">"`</span><span class="se">\n\n</span><span class="s">"</span> <span class="o">+</span> <span class="n">markdown_table</span><span class="p">(</span><span class="n">rowcount_changes</span><span class="p">(</span><span class="n">common_tables</span><span class="p">,</span> <span class="n">prod_db</span><span class="p">,</span> <span class="n">update_db</span><span class="p">))</span> <span class="o">+</span> <span class="s">"</span><span class="se">\n\n\n</span><span class="s">"</span>
<span class="n">formatted_previews</span> <span class="o">=</span> <span class="n">formatted_previews</span><span class="p">(</span><span class="n">update_name</span><span class="p">,</span> <span class="n">update_db</span><span class="p">,</span> <span class="n">common_tables</span><span class="p">)</span>

<span class="c"># concatenate report info as a single string</span>
<span class="n">file_as_string</span> <span class="o">=</span> <span class="n">h1</span> <span class="o">+</span> <span class="n">missing_table_list</span> <span class="o">+</span> <span class="n">rowcount_changes</span> <span class="o">+</span> <span class="n">update_previews</span>

<span class="c"># write string to filepath</span>
<span class="n">filepath</span> <span class="o">=</span> <span class="n">file_prefix</span> <span class="o">+</span><span class="s">"-"</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">"</span><span class="si">%</span><span class="s">m-</span><span class="si">%</span><span class="s">d-</span><span class="si">%</span><span class="s">Y"</span><span class="p">)</span> <span class="o">+</span> <span class="s">".md"</span>
<span class="k">print</span> <span class="s">"Writing results of ingestion to "</span> <span class="o">+</span> <span class="n">filepath</span> <span class="o">+</span> <span class="s">"..."</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
<span class="k">except</span> <span class="nb">OSError</span><span class="p">:</span>
    <span class="k">pass</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">codecs</span><span class="o">.</span><span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">'utf-8'</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">"w+"</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">unicode</span><span class="p">(</span><span class="n">file_as_string</span><span class="p">,</span><span class="s">'utf-8'</span><span class="p">))</span>

</code></pre></div></div>

<h2 id="multi-purpose-methods">multi-purpose methods</h2>

<p><em><sup>(Add the following methods before the config section of the main script, or put them in another file like <code class="highlighter-rouge">helpers.py</code> to be imported as a local module.)</sup></em></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">def</span> <span class="nf">connect_db</span><span class="p">(</span><span class="n">db_name</span><span class="p">):</span> <span class="c"># takes a database name, returns a db connector</span>
  <span class="k">return</span> <span class="n">pymysql</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">db_host</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">db_user</span><span class="p">,</span> <span class="n">passwd</span><span class="o">=</span><span class="n">db_pass</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="n">db_name</span><span class="p">,</span> <span class="n">charset</span><span class="o">=</span><span class="s">'utf8'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">show_tables</span><span class="p">(</span><span class="n">db</span><span class="p">):</span> <span class="c"># takes a db connector, returns an array table names</span>
  <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="s">"SHOW TABLES;"</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">db</span><span class="p">)</span>
  <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">df</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span> <span class="c"># takes a db connector and a table name, and returns a pandas dataframe from that table</span>
  <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="s">"SELECT * FROM "</span> <span class="o">+</span> <span class="n">table</span> <span class="o">+</span> <span class="s">";"</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">db</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">df_sample</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">limit</span><span class="p">):</span> <span class="c"># same as df(), but only returns a sample of LIMIT # of rows</span>
  <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="s">"SELECT * FROM "</span> <span class="o">+</span> <span class="n">table</span> <span class="o">+</span> <span class="s">" LIMIT "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span> <span class="o">+</span> <span class="s">";"</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">db</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">df_rowcount</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span> <span class="c"># takes a db connector and a table name, and returns a the rowcount (int) of that table</span>
  <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="s">'SELECT COUNT(*) FROM '</span> <span class="o">+</span> <span class="n">table</span> <span class="o">+</span> <span class="s">';'</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">db</span><span class="p">)[</span><span class="s">'COUNT(*)'</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">markdown_table</span><span class="p">(</span><span class="n">df</span><span class="p">):</span> <span class="c"># takes a pandas dataframe and tur it into returns it as a (string) markdown table</span>
  <span class="n">df_fmt</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">fmt</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
  <span class="n">df_formatted</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_fmt</span><span class="p">,</span> <span class="n">df</span><span class="p">])</span>
  <span class="k">return</span> <span class="n">df_formatted</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">sep</span><span class="o">=</span><span class="s">"|"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">'utf-8'</span><span class="p">,</span> <span class="n">quotechar</span><span class="o">=</span><span class="s">"*"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">rowcount_changes</span><span class="p">(</span><span class="n">shared_tables</span><span class="p">,</span> <span class="n">db1</span><span class="p">,</span> <span class="n">db2</span><span class="p">):</span> <span class="c"># takes a list of common tables and both db connectors, returns a (string) markdown table representing the changes</span>
  <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s">'table'</span><span class="p">,</span><span class="s">'production db rowcount'</span><span class="p">,</span><span class="s">'update db rowcount'</span><span class="p">,</span><span class="s">'</span><span class="si">% </span><span class="s">difference'</span><span class="p">]</span>
  <span class="n">differential_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">)</span>

  <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">shared_tables</span><span class="p">:</span>
    <span class="n">db1_rowcount</span> <span class="o">=</span> <span class="n">df_rowcount</span><span class="p">(</span><span class="n">db1</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>
    <span class="n">db2_rowcount</span> <span class="o">=</span> <span class="n">df_rowcount</span><span class="p">(</span><span class="n">db2</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>

    <span class="n">difference</span> <span class="o">=</span> <span class="n">db2_rowcount</span> <span class="o">-</span> <span class="n">db1_rowcount</span>
    <span class="k">if</span> <span class="n">difference</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">difference</span> <span class="o">=</span> <span class="p">(</span><span class="n">difference</span> <span class="o">/</span> <span class="n">db1_rowcount</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>

    <span class="n">temp_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([[</span><span class="s">"`"</span> <span class="o">+</span> <span class="n">table</span> <span class="o">+</span> <span class="s">"`"</span><span class="p">,</span> <span class="n">prod_count</span><span class="p">,</span> <span class="n">update_count</span><span class="p">,</span> <span class="n">difference</span><span class="p">]],</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">)</span>

    <span class="n">differential_df</span> <span class="o">=</span> <span class="n">differential_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp_df</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">differential_df</span><span class="p">[</span><span class="s">'production db rowcount'</span><span class="p">]</span> <span class="o">=</span> <span class="n">differential_df</span><span class="p">[</span><span class="s">'production db rowcount'</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">differential_df</span><span class="p">[</span><span class="s">'update db rowcount'</span><span class="p">]</span> <span class="o">=</span> <span class="n">differential_df</span><span class="p">[</span><span class="s">'update db rowcount'</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">differential_df</span><span class="p">[</span><span class="s">'</span><span class="si">% </span><span class="s">difference'</span><span class="p">]</span> <span class="o">=</span> <span class="n">differential_df</span><span class="p">[</span><span class="s">'</span><span class="si">% </span><span class="s">difference'</span><span class="p">]</span>

  <span class="k">return</span> <span class="n">differential_df</span>

<span class="k">def</span> <span class="nf">formatted_previews</span><span class="p">(</span><span class="n">db_name</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">tables</span><span class="p">):</span> <span class="c"># takes a db name, db connector, and list of tables, returns a string representation of previews for each table in that db</span>
    <span class="n">all_tables_string</span> <span class="o">=</span> <span class="s">"### `"</span> <span class="o">+</span> <span class="n">db_name</span> <span class="o">+</span> <span class="s">" ` preview </span><span class="se">\n\n</span><span class="s">"</span>
    <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
        <span class="n">df_head</span> <span class="o">=</span> <span class="n">df_sample</span><span class="p">(</span><span class="n">db</span><span class="p">,</span><span class="n">table</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df_head</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">is_string_dtype</span><span class="p">(</span><span class="n">df_head</span><span class="p">[</span><span class="n">col</span><span class="p">]):</span>
                <span class="n">df_head</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_head</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="nb">str</span><span class="p">[:</span><span class="mi">200</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">,</span><span class="s">' '</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">all_tables_string</span> <span class="o">+=</span> <span class="s">"#### `"</span> <span class="o">+</span> <span class="n">table</span> <span class="o">+</span> <span class="s">"`</span><span class="se">\n\n</span><span class="s">"</span> <span class="o">+</span> <span class="n">markdown_table</span><span class="p">(</span><span class="n">df_head</span><span class="p">)</span> <span class="o">+</span> <span class="s">"</span><span class="se">\n\n</span><span class="s">"</span>
    <span class="k">return</span> <span class="n">all_tables_string</span>

<span class="k">def</span> <span class="nf">common_tables</span><span class="p">(</span><span class="n">table_list1</span><span class="p">,</span> <span class="n">table_list2</span><span class="p">):</span> <span class="c"># takes lists of tables, returns list of tables present in both lists</span>
  <span class="n">common</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">table_list1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">table_list2</span><span class="p">))</span>
  <span class="n">common</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
  <span class="k">return</span> <span class="n">common</span>

<span class="k">def</span> <span class="nf">missing_tables</span><span class="p">(</span><span class="n">table_list1</span><span class="p">,</span> <span class="n">common_table_list</span><span class="p">):</span> <span class="c"># returns array of table names in table list that aren't in the common list</span>
  <span class="n">missing</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">prod_tables</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">common_tables</span><span class="p">]</span>
  <span class="n">missing</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
  <span class="k">return</span> <span class="n">missing</span>

<span class="k">def</span> <span class="nf">format_list</span><span class="p">(</span><span class="n">heading</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span> <span class="c"># returns md formatted list w h3 heading</span>
  <span class="n">list_string</span> <span class="o">=</span> <span class="s">"###"</span> <span class="o">+</span> <span class="n">heading</span><span class="p">:</span> <span class="o">+</span> <span class="s">" </span><span class="se">\n</span><span class="s">"</span>
  <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">:</span>
      <span class="n">list_string</span> <span class="o">+=</span> <span class="s">"- "</span> <span class="o">+</span> <span class="n">item</span> <span class="o">+</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span>
  <span class="k">return</span> <span class="n">list_string</span> <span class="o">+</span> <span class="s">"</span><span class="se">\n\n\n</span><span class="s">"</span>

</code></pre></div></div>

<h2 id="results-excerpt">Results (excerpt):</h2>

<p><em><sup>(The real report is <strong>much</strong> longer than this, and would be way more tedious to produce manually!)</sup></em></p>

<script src="https://gist.github.com/mnyrop/4d50065321edd0d445c7e66eed9483b6.js"></script>

<h2 id="final-thoughts">Final thoughts:</h2>

<p>I’m hoping to implement this style of automated documentation across History_Lab’s various collection ingestion pipelines. The goal is not only to create standardized, thorough system for documentation, but also to better understand changes to the collection over time and anticipate possible issues.</p>

<p>After several ingestion reports on are generated per collection, I’m hoping to apply insights from them in making the ingestion scripts themselves much smarter—for example by flagging when table row counts change in unexpected ways.</p>


</article>

<div class="page-navigation">
	
		<a class="home" href="http://localhost:8000/" title="Back to Homepage">Home</a>
  
		<span> &middot; </span>
    <a class="prev" href="http://localhost:8000/notes/jekyll-ci" title="PREV: Continuous Integration!<br>Or: Jekyll gets some robot nannies.">&gt;&gt;</a>
  
</div>

		</main>

		<div class="footer">
  <br><br><br><br>
  <button>
    <a href="https://twitter.com/mariinyrop" target="_none">
      <i class="fa fa-lg fa-twitter" aria-hidden="true"></i>
    </a>
  </button>
  &nbsp;&nbsp;
  <button>
    <a href="https://github.com/mnyrop" target="_none">
      <i class="fa fa-lg fa-code-fork" aria-hidden="true"></i>
    </a>
  </button>
  &nbsp;&nbsp;
  <button id="btn" data-clipboard-text="m.nyrop@columbia.edu">
    <i class="fa fa-lg fa-envelope-o" aria-hidden="true"></i>
  </button>
  &nbsp;&nbsp;
  <button>
    <a href="https://stackoverflow.com/users/8227741/marii" target="_none">
      <i class="fa fa-lg fa-stack-overflow" aria-hidden="true"></i>
    </a>
  </button>
  &nbsp;&nbsp;
  <button>
    <a href="https://jsfiddle.net/user/marii_/fiddles/" target="_none">
      <i class="fa fa-lg fa-jsfiddle" aria-hidden="true"></i>
    </a>
  </button>
  &nbsp;&nbsp;
  <button>
    <a href="https://rubygems.org/profiles/marii" target="_none">
      <i class="fa fa-lg fa-diamond" aria-hidden="true"></i>
    </a>
  </button>
  &nbsp;&nbsp;
  <!-- <button>
    <a href="/shelf">
      <i class="fa fa-lg fa-book" aria-hidden="true"></i>
    </a>
  </button> -->
  <br><br>
  <br><br><br>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.5.10/clipboard.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script src="https://netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>
<style>
  .tooltip{position:absolute;z-index:1030;display:block;font-size:12px;line-height:1.4;opacity:0;filter:alpha(opacity=0);visibility:visible}.tooltip.in{opacity:.9;filter:alpha(opacity=90)}.tooltip.top{padding:5px 0;margin-top:-3px}.tooltip.right{padding:0 5px;margin-left:3px}.tooltip.bottom{padding:5px 0;margin-top:3px}.tooltip.left{padding:0 5px;margin-left:-3px}.tooltip-inner{max-width:200px;padding:3px 8px;color:#fff;text-align:center;text-decoration:none;background-color:#000;border-radius:4px}.tooltip-arrow{position:absolute;width:0;height:0;border-color:transparent;border-style:solid}.tooltip.top .tooltip-arrow{bottom:0;left:50%;margin-left:-5px;border-top-color:#000;border-width:5px 5px 0}.tooltip.top-left .tooltip-arrow{bottom:0;left:5px;border-top-color:#000;border-width:5px 5px 0}.tooltip.top-right .tooltip-arrow{right:5px;bottom:0;border-top-color:#000;border-width:5px 5px 0}.tooltip.right .tooltip-arrow{top:50%;left:0;margin-top:-5px;border-right-color:#000;border-width:5px 5px 5px 0}.tooltip.left .tooltip-arrow{top:50%;right:0;margin-top:-5px;border-left-color:#000;border-width:5px 0 5px 5px}.tooltip.bottom .tooltip-arrow{top:0;left:50%;margin-left:-5px;border-bottom-color:#000;border-width:0 5px 5px}.tooltip.bottom-left .tooltip-arrow{top:0;left:5px;border-bottom-color:#000;border-width:0 5px 5px}.tooltip.bottom-right .tooltip-arrow{top:0;right:5px;border-bottom-color:#000;border-width:0 5px 5px}
</style>
<script>
  $('#btn').tooltip({
    trigger: 'click',
    placement: 'bottom'
  });
  function setTooltip(message) {
    $('#btn').tooltip('hide')
      .attr('data-original-title', message)
      .tooltip('show');
  }
  function hideTooltip() {
    setTimeout(function() {
      $('button').tooltip('hide');
    }, 1000);
  }
  // Clipboard
  var clipboard = new Clipboard('button');
  clipboard.on('success', function(e) {
    setTooltip('Copied to clipboard!');
    hideTooltip();
  });
  clipboard.on('error', function(e) {
    setTooltip('Failed!');
    hideTooltip();
  });
</script>


	</body>

</html>
